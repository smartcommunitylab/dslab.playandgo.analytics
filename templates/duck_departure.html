<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa H3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 80vh; width: 100%; margin-top: 10px; }
        .controls { margin-bottom: 10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
        .controls input, .controls select { margin-right: 8px; }
        /* Pulsante Load più visibile */
        .btn-load {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(180deg,#ff7f50,#ff5a36);
            color: #fff;
            border: none;
            padding: 10px 14px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: transform .08s, box-shadow .08s, opacity .12s;
        }
        .btn-load:active { transform: translateY(1px); }
        .btn-load[disabled] { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        .btn-icon {
            width: 18px;
            height: 18px;
            display:inline-block;
            vertical-align:middle;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
</head>
<body>
    <h2>Mappa partenza/arrivo su cella H3</h2>
    <div class="controls">
        <label>Territorio: <input type="text" id="territory_id" value="L"></label>
        <label>Campagna: <input type="text" id="campaign_id" value="L.personal"></label>
        <label>Gruppo: <input type="text" id="group_id" value=""></label>
        <label>Risoluzione: <input type="number" id="target_resolution" value="7" min="5" max="10"></label>
        <label>Modalità:
            <select id="mode">
                <option value="">All</option>
                <option value="walk">Walk</option>
                <option value="bike">Bike</option>
                <option value="bus">Bus</option>
                <option value="train">Train</option>
            </select>
        </label>
        <label>Fascia oraria:
            <select id="time_slot">
                <option value="">Tutti</option>
                <option value="05-10">05:00 - 09:59</option>
                <option value="10-15">10:00 - 14:59</option>
                <option value="15-20">15:00 - 19:59</option>
                <option value="20-05">20:00 - 04:59</option>
            </select>
        </label>
        <label>Utenti minimi:
            <input type="number" id="min_tracks" value="5" min="1" max="25" style="width:60px;">
        </label>
        <br>
        <label>Cella: <input type="text" id="h3_cell" value="871f99813ffffff"></label>
        <label style="margin-left:6px;">
            Tipo:
            <select id="is_departure">
                <option value="true" selected>Partenza</option>
                <option value="false">Destinazione</option>
            </select>
        </label>

        <!-- Pulsante Load più visibile con icona -->
        <button id="btn-load" class="btn-load" onclick="loadGeoJson()" title="Carica dati H3">
            <!-- semplice icona SVG di caricamento/map -->
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#fff" stroke-width="1.6" fill="rgba(255,255,255,0.06)"/>
            </svg>
            Load
        </button>
    </div>

    <!-- Loader -->
    <div id="loader" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999;">
        <span style="background:#fff;padding:20px 40px;border-radius:8px;box-shadow:0 0 10px #aaa;font-size:1.2em;">
            Caricamento...
        </span>
    </div>
    <div id="map"></div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Centra la mappa su Lecco
        var map = L.map('map').setView([45.8566, 9.3977], 10);

        // Aggiungi il layer OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        var geoJsonLayer = null;
        var btnLoad = document.getElementById('btn-load');

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        function setLoadingState(isLoading) {
            showLoader(isLoading);
            btnLoad.disabled = isLoading;
        }

        function loadGeoJson() {
            var territory_id = document.getElementById('territory_id').value;
            var campaign_id = document.getElementById('campaign_id').value;
            var target_resolution = document.getElementById('target_resolution').value;
            var mode = document.getElementById('mode').value;
            var time_slot = document.getElementById('time_slot').value;
            var group_id = document.getElementById('group_id').value;
            var min_tracks = document.getElementById('min_tracks').value;
            var h3_cell = document.getElementById('h3_cell').value;
            var is_departure = document.getElementById('is_departure').value === 'true';

            // Base URL con param obbligatori
            var params = [];
            params.push("territory_id=" + encodeURIComponent(territory_id));
            params.push("campaign_id=" + encodeURIComponent(campaign_id));
            params.push("target_resolution=" + encodeURIComponent(target_resolution));
            params.push("min_tracks=" + encodeURIComponent(min_tracks));
            params.push("h3_cell=" + encodeURIComponent(h3_cell));
            params.push("is_departure=" + encodeURIComponent(is_departure));

            // Aggiungi mode e time_slot solo se non stringhe vuote
            if (mode && mode !== "") {
                params.push("mode=" + encodeURIComponent(mode));
            }
            if (time_slot && time_slot !== "") {
                params.push("time_slot=" + encodeURIComponent(time_slot));
            }
            if (group_id && group_id !== "") {
                params.push("group_id=" + encodeURIComponent(group_id));
            }
            
            var url = "/api/geo/duck/departure?" + params.join("&");

            setLoadingState(true);
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    // calcola min/max di unique_users dai feature ricevuti
                    const vals = (data.features || []).map(f => {
                        const v = Number((f.properties && f.properties.unique_users) || 0);
                        return isNaN(v) ? 0 : v;
                    });
                    const minVal = vals.length ? Math.min(...vals) : 0;
                    const maxVal = vals.length ? Math.max(...vals) : 0;

                    // crea la scala cromatica: uso YlOrRd e inverto domain per ottenere
                    // colori più scuri per valori piccoli e più chiari per valori grandi.
                    // Cambia il nome della palette se preferisci (es. 'YlGnBu', 'Viridis', ...)
                    colorScale = chroma.scale('YlOrRd').domain([minVal, maxVal]);

                    if (geoJsonLayer) {
                        map.removeLayer(geoJsonLayer);
                    }

                    geoJsonLayer = L.geoJSON(data, {
                        style: function(feature) {
                            const props = feature.properties || {};
                            const u = Number(props.unique_users || 0) || 0;
                            const fill = colorScale(u).hex();
                            const style = {
                                color: '#000000',
                                fillColor: fill,
                                weight: 1,
                                fillOpacity: 0.6
                            };
                            // evidenzia partenza/destinazione (se condizione già presente)
                            if (is_departure) {
                                if (props.h3_end_parent == h3_cell) {
                                    style.color = '#ff0000';
                                    style.weight = 3;
                                }
                            } else {
                                if (props.h3_start_parent == h3_cell) {
                                    style.color = '#ff0000';
                                    style.weight = 3;
                                }
                            }
                            return style;
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                var userText = feature.properties.unique_users !== undefined ? ("Utenti: " + feature.properties.unique_users) : "";
                                layer.bindPopup(userText);
                            }
                        }
                    }).addTo(map);

                    if (geoJsonLayer.getBounds && geoJsonLayer.getBounds().isValid()) {
                        map.fitBounds(geoJsonLayer.getBounds());
                    }
                })
                .catch(error => {
                    alert("Errore nel caricamento dei dati GeoJSON.");
                    console.error(error);
                })
                .finally(() => {
                    setLoadingState(false);
                });
        }
    </script>
</body>
</html>